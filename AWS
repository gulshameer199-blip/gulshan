#!/usr/bin/env python3
"""
Build and zip an AWS Lambda deployment package for Python.

Usage example:
    export SRC_DIR=./src
    export REQS_FILE=requirements.txt
    export OUTPUT_ZIP=lambda_package.zip
    python build_lambda_zip.py
"""

import os
import shutil
import subprocess
import sys
import tempfile
import zipfile
from pathlib import Path


def run(cmd: list[str], cwd: str | None = None) -> None:
    print(f"Running: {' '.join(cmd)}")
    try:
        subprocess.check_call(cmd, cwd=cwd)
    except subprocess.CalledProcessError as e:
        print(f"Command failed with exit code {e.returncode}: {e}")
        sys.exit(e.returncode)


def create_zip_from_dir(source_dir: Path, zip_path: Path) -> None:
    if zip_path.exists():
        zip_path.unlink()

    with zipfile.ZipFile(zip_path, "w", zipfile.ZIP_DEFLATED) as zf:
        for root, _, files in os.walk(source_dir):
            for filename in files:
                full_path = Path(root) / filename
                # Make paths inside zip relative to source_dir root
                arcname = full_path.relative_to(source_dir)
                zf.write(full_path, arcname.as_posix())
    print(f"Created zip package: {zip_path}")


def build_lambda_package(
    src_dir: Path,
    requirements_file: Path | None,
    output_zip: Path,
    python_bin: str = sys.executable,
) -> None:
    # Create temp directory to stage all files
    with tempfile.TemporaryDirectory() as tmpdir_str:
        tmpdir = Path(tmpdir_str)
        print(f"Staging build in: {tmpdir}")

        # 1. Install dependencies (if any) into temp dir, as AWS expects.[web:15][web:18]
        if requirements_file and requirements_file.is_file():
            print(f"Installing requirements from {requirements_file}")
            run(
                [
                    python_bin,
                    "-m",
                    "pip",
                    "install",
                    "--upgrade",
                    "pip",
                ]
            )
            run(
                [
                    python_bin,
                    "-m",
                    "pip",
                    "install",
                    "-r",
                    str(requirements_file),
                    "-t",
                    str(tmpdir),
                ]
            )
        else:
            print("No requirements file provided or file does not exist; skipping deps.")

        # 2. Copy source code into temp dir root (handler files, etc.).[web:15][web:18]
        print(f"Copying source from {src_dir}")
        for item in src_dir.iterdir():
            dest = tmpdir / item.name
            if item.is_dir():
                shutil.copytree(item, dest, dirs_exist_ok=True)
            else:
                shutil.copy2(item, dest)

        # 3. Zip everything in temp dir into output_zip.[web:15][web:18]
        create_zip_from_dir(tmpdir, output_zip)


if __name__ == "__main__":
    # Read config from env vars (with sensible defaults)
    src_dir_env = os.getenv("SRC_DIR", ".")
    reqs_file_env = os.getenv("REQS_FILE", "requirements.txt")
    output_zip_env = os.getenv("OUTPUT_ZIP", "lambda_package.zip")

    src_dir = Path(src_dir_env).resolve()
    requirements_file = Path(reqs_file_env).resolve()
    output_zip = Path(output_zip_env).resolve()

    if not src_dir.is_dir():
        print(f"Source directory {src_dir} does not exist or is not a directory.")
        sys.exit(1)

    print(f"SRC_DIR      = {src_dir}")
    print(f"REQS_FILE    = {requirements_file} (optional)")
    print(f"OUTPUT_ZIP   = {output_zip}")

    build_lambda_package(
        src_dir=src_dir,
        requirements_file=requirements_file if requirements_file.exists() else None,
        output_zip=output_zip,
    )
